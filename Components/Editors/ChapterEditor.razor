@inherits GenericEditorBase<Chapter>

@using Squill.Data;
@using System.Text;

<MudPaper Elevation="15" Style="height: 1.5rem;" Outlined=true>
    <EditForm EditContext="m_context">
        <MarkdownEditor @bind-Value=Target.Content WordStyle="InsertTags" />
    </EditForm>
</MudPaper>

@code {
    private EditContext m_context;

    protected override void OnInitialized()
    {
        m_context = new EditContext(Element);
    }

    private string InsertTags(string rawInput)
    {
        var sb = new StringBuilder();
        var w = rawInput.Split(' ');
        foreach (var word in w)
        {
            var element = Session.ElementMeta.FirstOrDefault(m => m.Name == word);
            if (element != null)
            {
                var color = Type.GetType(element.Type).GetColor().ToString();
                if (element.Attributes.TryGetValue("color", out var colVal))
                {
                    color = colVal;
                }
                sb.Append($"<span class=\"tag\" style=\"background-color:{color};outline: 5px solid {color};\">");
            }
            sb.Append(word);
            if (element != null)
            {
                sb.Append("</span>");
            }
            sb.Append(' ');
        }
        return sb.ToString();
    }

    public override RenderFragment Toolbar => __builder =>
    {
        <MudSpacer />
        <MudTooltip Arrow=true RootStyle="display:flex;justify-content:center;">
            <ChildContent>
                <MudIcon Icon="@Icons.Material.Outlined.Numbers" Size="Size.Small" />@Target.WordCount
            </ChildContent>
            <TooltipContent>
                Word Count
            </TooltipContent>
        </MudTooltip>
        <MudDivider Vertical=true Style="margin: 0 .5rem 0 .5rem;" />
        @if (!Guid.TryParse(Target.Owner, out var ownerGuid))
        {
            <span class="toolbar-label">Chapter not owned by any manuscript.</span>
        }
        else
        {
            var ownerMeta = Session.GetMetaData(ownerGuid);
            if (ownerMeta == null)
            {
                <span class="toolbar-label">Bad chapter link, please reestablish.</span>
            }
            else
            {
                <span class="toolbar-label">Chapter of <ElementLink Element="ownerGuid" Session="Session" TabManager="TabManager"  /></span>
            }
        }
        <MudDivider Vertical=true Style="margin: 0 .5rem 0 .5rem;" />
    };
}
