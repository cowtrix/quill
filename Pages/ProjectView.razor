@page "/project/{Guid}"
@page "/project/{Guid}/{Element}"
@page "/project/"
@using Squill.Components
@using Squill.Components.Editors
@using Squill.Data;
@using Squill.Services;
@using Squill.Data.Elements;

@inject ProjectService ProjectService
@inject NavigationManager NavManager
@inject UserService UserService

<PageTitle>@GetPageTitle()</PageTitle>
<TabManager @ref=TabManager Session="Session" />

@if (UserService.CurrentUser == null)
{
    <div>Not logged in</div>
}
else if (!Session.IsSynchronized)
{
    <div>Synchronizing</div>
}
else
{
    <DiffDisplay Session="Session" />
    @if (TabManager != null)
    {
        <MudTabs @bind-ActivePanelIndex="TabManager.Index" Border="true" Outlined="true" PanelClass="tab-panel-container" ApplyEffectsToContainer="true">
            <ChildContent>
                @foreach (var tab in TabManager.Tabs)
                {
                    <MudTabPanel Text="@(!tab.IsEditing ? (tab.NameOverride ?? tab.Target.Name) : "")" Tag="@tab">
                        @{
                            if (tab.Target == null)
                            {
                                <ProjectExplorer Session=Session TabManager=TabManager />
                            }
                            else
                            {
                                <EditorWrapper Session="Session" @ref=EditorWrapper Element="Session.GetElement<IElement>(tab.Target)" TabManager="TabManager">
                                    <ChildContent>
                                        <CascadingValue Value="EditorWrapper">
                                            @{
                                                var t = Type.GetType(tab.Target.Type);
                                                switch (t.Name)
                                                {
                                                    case nameof(Manuscript):
                                                        <ManuscriptEditor />
                                                        break;
                                                    case nameof(Chapter):
                                                        <ChapterEditor />
                                                        break;
                                                    case nameof(Character):
                                                        <CharacterEditor />
                                                        break;
                                                    case nameof(Timeline):
                                                        <TimelineEditor />
                                                        break;
                                                }
                                            }
                                        </CascadingValue>
                                    </ChildContent>
                                </EditorWrapper>
                            }
                        }
                    </MudTabPanel>
                }
            </ChildContent>
            <TabPanelHeader>
                @{
                    var tab = context.Tag as TabManager.TabView;
                    if (!tab.Sticky)
                    {
                        if (tab.IsEditing)
                        {
                            <MudStack Class="tab-rename" Row="true" Style="max-height: 2rem;">
                                <MudTextField @bind-Value=tab.NameOverride Style="margin: 0;" IconSize="Size.Small" Margin="Margin.Dense" />
                                <MudIconButton Size=Size.Small Class="ml-2 pa-1" Icon="@Icons.Material.Filled.Check" OnClick="async (_) => await TabManager.FinishRename(context)" />
                            </MudStack>
                        }
                        else
                        {
                            <div class="fade-hover">
                                <MudTooltip>
                                    <ChildContent>
                                        <MudIconButton Class="ml-2" Icon="@Icons.Material.Filled.Edit" OnClick="(_) => TabManager.BeginRename(context)" Size="Size.Small" Variant="Variant.Outlined" />
                                    </ChildContent>
                                    <TooltipContent>Rename</TooltipContent>
                                </MudTooltip>
                                <MudTooltip>
                                    <ChildContent>
                                        <MudIconButton Color="Color.Error" Icon="@Icons.Material.Filled.Remove" OnClick="(_) => TabManager.RemoveTab(context)" Size="Size.Small" Variant="Variant.Outlined" />
                                    </ChildContent>
                                    <TooltipContent>Close Tab</TooltipContent>
                                </MudTooltip>
                            </div>
                        }
                    }
                }
            </TabPanelHeader>
        </MudTabs>
    }
}

@code {
    [Parameter]
    public string Guid { get; set; }

    [Parameter]
    public string Element { get; set; }

    public ProjectSession Session { get; set; }

    public TabManager TabManager { get; set; }

    private EditorWrapper EditorWrapper { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (System.Guid.TryParse(Guid, out var guid))
        {
            Session = await ProjectService.GetSession(guid);
        }
        if (!Session.IsSynchronized)
        {
            Session.TryStartSynchronize();
            Session.OnSynchronized += OnSynchronized;
        }
    }

    private void FocusTab(object? sender, TabManager.TabView tab)
    {
        if (tab?.Target != null)
        {
            NavManager.NavigateTo($"/project/{Session.Project.Guid}/{tab.Target.Guid}");
        }
        else
        {
            NavManager.NavigateTo($"/project/{Session.Project.Guid}/");
        }
        StateHasChanged();
    }

    private void OnSynchronized(object? sender, EventArgs args)
    {
        InvokeAsync(StateHasChanged);
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            TabManager.AddTab(null, "Elements", true);
            TabManager.OnTabAdded += FocusTab;
            TabManager.OnTabFocused += FocusTab;
            TabManager.OnTabRemoved += FocusTab;
        }

        if (Element != null && System.Guid.TryParse(Element, out var elementGuid) &&
            !TabManager.Tabs.Any(t => t.Target?.Guid == elementGuid.ToString()))
        {
            TabManager.AddTab(Session.GetMetaData(elementGuid));
        }
    }

    private string GetPageTitle()
    {
        if (TabManager.CurrentTab?.Target != null)
        {
            return $"{Session.Project.Name} > {TabManager.CurrentTab.Target.Name}";
        }
        else
        {
            return Session.Project.Name;
        }
    }
}
